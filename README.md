# Receipt Extraction Toolkit

A TypeScript + Playwright utility that loads a Slyp receipt URL, captures the underlying JSON API payload, transforms it into a clean, validated domain model, and emits:

- `receipt.api.raw.json` – raw API response
- `receipt.clean.json` – normalized structured receipt with provenance meta
- `receipt.validation.json` – schema + integrity results
- `receipt.schema.json` – JSON Schema (versioned)
- `openapi.receipt.json` – OpenAPI 3.1 component embedding the schema
- Batch mode: per-index artifacts + `batch.manifest.json`

## Features
- API-first capture (no brittle DOM scraping)
- Deterministic transform with `schemaVersion` + `transformVersion`
- Provenance meta: `runId`, `receiptId`, `rawHash`
- Integrity checks (line totals, payments, subtotal+tax, aggregation parity)
- Redaction + `--pii-strict` enforcement
- Batch processing with concurrency `--concurrency N`
- Structured JSON logging (stdout or file via `--log`)
- OpenAPI + JSON Schema emission
- Unit tests (Vitest) with coverage thresholds

## CI & Release

GitHub Actions workflows:
- `CI` (`.github/workflows/ci.yml`) runs on pushes & PRs: install, build, test, coverage, strict validation, advisory schema version check.
- `Release` (`.github/workflows/release.yml`) runs on pushes to `main`/`master` and performs semantic-release (GitHub + npm publish) when commits follow Conventional Commits.

Add a badge (after first push to default branch):
```
![CI](https://github.com/<your-org-or-user>/<repo>/actions/workflows/ci.yml/badge.svg)
```

### Semantic Versioning Policy
- PATCH: internal fixes, doc updates, non-schema changes.
- MINOR: additive schema fields (backwards compatible), new CLI flags with defaults.
- MAJOR: breaking schema / contract changes, removal of flags, incompatible behavior changes.

### Release Automation Details
Semantic-release plugins configured:
- `@semantic-release/changelog` updates CHANGELOG.md
- `@semantic-release/npm` publishes package (requires `NPM_TOKEN` secret)
- `@semantic-release/github` creates GitHub Release (notes autogenerated)
- `@semantic-release/git` commits updated CHANGELOG + version bump

Ensure repository secrets:
- `NPM_TOKEN` (publish access)

Conventional Commit examples:
- `feat: add refunds handling`
- `fix: correct tax aggregation rounding`
- `perf: reduce redundant navigation attempts`
- `refactor!: change receiptId generation algorithm` (break)

Schema changes should also update `SCHEMA_VERSION` in `receipt.ts` and regenerate the snapshot (`vitest -u` if intended) so CI advisory check passes.

## Install
```
npm install
npm run build
```

## CLI
After build you can run:
```
node dist/scrape-slyp-receipt.js --url <receiptUrl>
```
Or if published / linked globally:
```
receipt-scraper --url <receiptUrl>
```

### Flags
- `--url <u>` Single receipt URL
- `--batch <file>` Newline list of URLs for batch mode
- `--outDir <dir>` Output directory (default `out`)
- `--strict` Fail (non-zero) on validation/integrity issues
- `--pii-strict` Enforce redaction (fail if unmasked PII remains)
- `--quiet` Suppress info logs
- `--log <file>` NDJSON log file path
- `--concurrency <N>` Parallel workers in batch mode

## Programmatic Usage
```ts
import { transformReceipt, validateReceipt, redactReceipt } from 'testplaywrightslyp/receipt';
// apiData is the raw JSON from Slyp endpoint
const receipt = transformReceipt(apiData);
redactReceipt(receipt);
const validation = validateReceipt(receipt);
```

## Schema & OpenAPI
- JSON Schema: `out/receipt.schema.json` ($id includes version)
- OpenAPI Component: `out/openapi.receipt.json` (components.schemas.Receipt)

## Meta Fields
```
meta: {
  schemaVersion: "1.0.0",
  transformVersion: "1.0.0",
  runId: "<uuid>",
  receiptId: "<sha256>",
  rawHash: "<sha256>",
  fetchedAtISO: "2025-..."
}
```

## Testing
```
npm test
```
Coverage thresholds enforced (lines >= 85%).

## Roadmap Ideas
- Browser context pooling (DONE)
- Rate limiting / adaptive backoff (INITIAL DONE; add backoff)
- Additional fixture scenarios (refunds, foreign currency)
- Publication to npm with semantic releases

## License
ISC (adjust as required).
