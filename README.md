# Receipt Extraction Toolkit

A TypeScript + Playwright utility that loads a Slyp receipt URL, captures the underlying JSON API payload, transforms it into a clean, validated domain model, and emits:

- `receipt.api.raw.json` – raw API response
- `receipt.clean.json` – normalized structured receipt with provenance meta
- `receipt.validation.json` – schema + integrity results
- `receipt.schema.json` – JSON Schema (versioned)
- `openapi.receipt.json` – OpenAPI 3.1 component embedding the schema
- Batch mode: per-index artifacts + `batch.manifest.json`

## Features
- API-first capture (no brittle DOM scraping)
- Deterministic transform with `schemaVersion` + `transformVersion`
- Provenance meta: `runId`, `receiptId`, `rawHash`
- Integrity checks (line totals, payments, subtotal+tax, aggregation parity)
- Redaction + `--pii-strict` enforcement
- Batch processing with concurrency `--concurrency N`
- Structured JSON logging (stdout or file via `--log`)
- OpenAPI + JSON Schema emission
- Unit tests (Vitest) with coverage thresholds

## CI & Release

GitHub Actions workflows:
- `CI` (`.github/workflows/ci.yml`) runs on pushes & PRs: install, build, test, coverage, strict validation, advisory schema version check.
- `Release` (`.github/workflows/release.yml`) runs on pushes to `main`/`master` and performs semantic-release (GitHub + npm publish) when commits follow Conventional Commits.

Add a badge (after first push to default branch):
```
![CI](https://github.com/<your-org-or-user>/<repo>/actions/workflows/ci.yml/badge.svg)
```

### Semantic Versioning Policy
- PATCH: internal fixes, doc updates, non-schema changes.
- MINOR: additive schema fields (backwards compatible), new CLI flags with defaults.
- MAJOR: breaking schema / contract changes, removal of flags, incompatible behavior changes.

### Release Automation Details
Semantic-release plugins configured:
- `@semantic-release/changelog` updates CHANGELOG.md
- `@semantic-release/npm` publishes package (requires `NPM_TOKEN` secret)
- `@semantic-release/github` creates GitHub Release (notes autogenerated)
- `@semantic-release/git` commits updated CHANGELOG + version bump

Ensure repository secrets:
- `NPM_TOKEN` (publish access)

Conventional Commit examples:
- `feat: add refunds handling`
- `fix: correct tax aggregation rounding`
- `perf: reduce redundant navigation attempts`
- `refactor!: change receiptId generation algorithm` (break)

Schema changes should also update `SCHEMA_VERSION` in `receipt.ts` and regenerate the snapshot (`vitest -u` if intended) so CI advisory check passes.

## Install
```
npm install
npm run build
```

## CLI
After build you can run:
```
node dist/scrape-slyp-receipt.js --url <receiptUrl>
```
Or if published / linked globally:
```
receipt-scraper --url <receiptUrl>
```

### Flags
- `--url <u>` Single receipt URL
- `--batch <file>` Newline list of URLs for batch mode
- `--outDir <dir>` Output directory (default `out`)
- `--strict` Fail (non-zero) on validation/integrity issues
- `--pii-strict` Enforce redaction (fail if unmasked PII remains)
- `--quiet` Suppress info logs
- `--log <file>` NDJSON log file path
- `--concurrency <N>` Parallel workers in batch mode
- `--rate-ms <ms>` Minimum delay between starting receipts (throttling)
- `--run-id <id>` Supply a custom run identifier (else generated)
- `--version` Print JSON with schemaVersion & transformVersion

### Validation & CI
Use the strict validation script (schema + integrity + PII strict if flag is present):
```
npm run validate:strict
```
Non-zero exit codes:
| Code | Meaning | Retry? |
|------|---------|--------|
| 0 | Success | n/a |
| 1 | Config/init error (missing batch file etc.) | Fix config |
| 2 | Validation / integrity / PII strict failure | Usually no (data issue) |
| 3 | Network / acquisition failure (no API JSON) | Yes (transient) |
| 4 | Unexpected internal error | Investigate |

### Imports Guidance
Stable public API import forms:
```ts
import { transformReceipt, validateReceipt } from 'testplaywrightslyp/receipt';
```
Avoid deep internal paths; only the export map is forward compatible.

### Batch Manifest Schema
`batch.manifest.json` example:
```json
{
  "ts": "2025-10-03T12:00:00.000Z",
  "runId": "<uuid>",
  "schemaVersion": "1.0.0",
  "transformVersion": "1.0.0",
  "count": 10,
  "ok": 10,
  "failed": 0,
  "avgDurationMs": 540,
  "results": [
    {
      "ok": true,
      "url": "https://receipts.slyp.com.au/...",
      "total": 30.15,
      "items": 3,
      "durationMs": 512,
      "issues": [],
      "receiptId": "<sha256>",
      "schemaVersion": "1.0.0",
      "transformVersion": "1.0.0"
    }
  ]
}
```
Downstream systems can dedupe via `receiptId` and validate version drift early.

### OpenAPI Compatibility Notes
The generated `openapi.receipt.json` targets OpenAPI 3.1.0 (full 2020-12 JSON Schema dialect). Consumers limited to 3.0.x may need a downgraded variant (future enhancement) since 3.0.x does not fully support all JSON Schema keywords.

### PII Redaction & Strict Mode
Redaction applies to:
- `merchant.phone` → masked to `***####` (last 4 digits)
- `merchant.abn` → masked to `***####`
- `payments[].maskedCard` → ensures only last 4 digits remain

Not redacted (intentional):
- `merchant.address.full` (location context retained)
- Item names, storeName, merchantName
- Loyalty program names / masked IDs (already masked by provider)

Strict scan (`--pii-strict`) fails if any remaining sequence of ≥7 digits is detected in redacted fields.

### Rate Limiting & Responsible Use
`--rate-ms` enforces a minimum spacing between receipt starts across workers (still approximate under concurrency). Recommended values: 250–500 ms for moderate loads. Respect platform terms; consider exponential backoff for repeated 429/5xx responses (future enhancement).

### Version Flag
`--version` prints:
```json
{ "schemaVersion": "1.0.0", "transformVersion": "1.0.0" }
```
Useful for health checks / deployment introspection.

## Programmatic Usage
```ts
import { transformReceipt, validateReceipt, redactReceipt } from 'testplaywrightslyp/receipt';
// apiData is the raw JSON from Slyp endpoint
const receipt = transformReceipt(apiData);
redactReceipt(receipt);
const validation = validateReceipt(receipt);
```

## Schema & OpenAPI
- JSON Schema: `out/receipt.schema.json` ($id includes version)
- OpenAPI Component: `out/openapi.receipt.json` (components.schemas.Receipt)

## Meta Fields
```
meta: {
  schemaVersion: "1.0.0",
  transformVersion: "1.0.0",
  runId: "<uuid>",
  receiptId: "<sha256>",
  rawHash: "<sha256>",
  fetchedAtISO: "2025-..."
}
```

## Testing
```
npm test
```
Coverage thresholds enforced (lines >= 85%).

## Roadmap Ideas
- Browser context pooling (DONE)
- Rate limiting / adaptive backoff (INITIAL DONE; add backoff)
- Additional fixture scenarios (refunds, foreign currency)
- Publication to npm with semantic releases

## License
ISC (adjust as required).
